Traceback (most recent call last):
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/jupyter_cache/executors/utils.py", line 58, in single_nb_execution
    executenb(
    ~~~~~~~~~^
        nb,
        ^^^
    ...<4 lines>...
        **kwargs,
        ^^^^^^^^^
    )
    ^
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/nbclient/client.py", line 1319, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/jupyter_core/utils/__init__.py", line 165, in wrapped
    return loop.run_until_complete(inner)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/nbclient/client.py", line 709, in async_execute
    await self.async_execute_cell(
        cell, index, execution_count=self.code_cells_executed + 1
    )
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/nbclient/client.py", line 1062, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "/Users/martinjanssens/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/nbclient/client.py", line 918, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
# With a sounding in it
ds = xr.open_dataset('Exercises/valencia.nc').isel(latitude=0,longitude=0).sel(valid_time='2024-10-29T15:00:00.000000000')

Rd = 287.05
Rv = 461.5 # J/kg/K, gas constant of water
lv_trip = 2500e3 # J/kg, latent heat of vaporisation at the triple point of water
T_trip = 273.15 # K, Temperature for triple point of water at 1000 hPa air pressure
es_trip = 610.94 # Pa, equilibrium vapour pressure at triple point of water

def Tdew(e):
    return (1/T_trip - Rv/lv_trip*np.log(e/es_trip))**(-1)
def e_sq(qs, p):
    return qs * p / (qs * (1-Rd/Rv) + Rd/Rv)

ds['tdew'] = Tdew(e_sq(ds.q, ds.pressure_level*100))

# To increase the width at the bottom of the original soundings for construction visualisation.
ds['t'].loc[ds.pressure_level > 900] += 1.5
ds['tdew'].loc[ds.pressure_level > 900] -= 2

Tad = np.hstack((np.arange(T_trip, T_trip+45, 5), np.arange(T_trip+15, T_trip+25, 2.5)))

fig = plt.figure()
skew = SkewT(fig, rotation=45)
skew.plot_dry_adiabats(Tad*units('K'))
skew.plot_moist_adiabats(Tad*units('K'))
skew.ax.set_xlabel('Temperature [C]')
skew.ax.set_ylabel('Pressure [hPa]')
skew.ax.set_ylim(1000, 250)

skew.ax.set_xticks(np.arange(-10,55,5))
secax = skew.ax.secondary_yaxis(-0.15,
    functions=(
        lambda p: mpcalc.pressure_to_height_std(units.Quantity(p, 'hPa')).m_as('km'),
        lambda h: mpcalc.height_to_pressure_std(units.Quantity(h, 'km')).m
    )
)
secax.yaxis.set_major_locator(plt.FixedLocator(np.arange(0,11,1)))
secax.yaxis.set_minor_locator(plt.NullLocator())
secax.yaxis.set_major_formatter(plt.ScalarFormatter())
secax.set_ylabel('Height (km)')

w = np.array([0.022, 0.016, 0.01, 0.006, 0.005, 0.004, 0.003, 0.002])[:, None] * units('g/g')
p = units.hPa * np.linspace(1000, 500, 7)
skew.plot_mixing_lines(mixing_ratio=w, pressure=p, color='darkseagreen', linestyle='-.')

# Label
for val in w.flatten():
    top_p = p[-1]
    dewpt = mpcalc.dewpoint(mpcalc.vapor_pressure(top_p, val))
    skew.ax.text(dewpt, top_p, str(int(val.to('g/kg').m)),
                 horizontalalignment='center')
fig.set_size_inches(10,10)

# Plot sounding
skew.plot(ds.pressure_level, ds.t-273.15, c='red', label='temp.')
skew.plot(ds.pressure_level, ds.tdew-273.65, c='red', linestyle='-.', label='dew-point temp.')
skew.ax.legend(frameon=False)
skew.ax.set_xlim(-10, 40)

# New
# Step 1: Get the temperature at 1000 hPa and convert to Â°C
temp_1000 = ds.t.sel(pressure_level=1000).values - 273.15  # Convert from K to Â°C

# Define the pressure levels for the dry adiabat (same as your dataset's pressure levels)
pressure_levels = ds.pressure_level.values * units('hPa')

# Calculate the dry adiabat starting from the temperature at 1000 hPa
dry_adiabat = mpcalc.dry_lapse(pressure_levels, 
                               units.Quantity(temp_1000, 'degC'), 
                               units.Quantity(1000, 'hPa'))

# Plot the dry adiabat line
skew.plot(pressure_levels, dry_adiabat, c='olive', linestyle='-', linewidth=2)

# Step 2: Calculate the mixing ratio at 1000 hPa using the dew point temperature
dewpoint_1000 = ds.tdew.sel(pressure_level=1000).values - 273.15  # Convert from K to Â°C

e = mpcalc.saturation_vapor_pressure(units.Quantity(dewpoint_1000, 'degC'))  # Saturation vapor pressure
mixing_ratio = mpcalc.mixing_ratio(e, units.Quantity(1000, 'hPa'))  # Mixing ratio at 1000 hPa

# Calculate the dew point temperature at each pressure level for the constant mixing ratio line
constant_mixing_ratio_line = []
for p in pressure_levels:
    e = mpcalc.vapor_pressure(units.Quantity(p, 'hPa'), mixing_ratio)  # Vapor pressure at pressure level p
    dewpoint = mpcalc.dewpoint(e)  # Dew point temperature at pressure level p
    constant_mixing_ratio_line.append(dewpoint.m_as('degC'))  # Convert to Â°C

# Plot the constant mixing ratio line
skew.plot(pressure_levels, constant_mixing_ratio_line, c='darkblue', linestyle='-', linewidth=2)

# Step 3: Find LCL
lcl = mpcalc.lcl(ds.pressure_level[0]*units('hPa'),
                 ds.t[0]*units('K'),
                 ds.tdew[0]*units('K'))
skew.ax.axhline(lcl[0], c='brown', linewidth=2)

prof = mpcalc.parcel_profile(ds.pressure_level*units('hPa'),
                             ds.t[0]*units('K'),
                             ds.tdew[0]*units('K'))
# Plot parcel for CAPE & CIN
skew.plot(ds.pressure_level, prof.values-273.15, c='k')
skew.shade_cape(ds.pressure_level.values*units('hPa'),
                (ds.t.values-273.15)*units('degC'),
                (prof.values-273.15)*units('degC'))

skew.shade_cin(ds.pressure_level.values*units('hPa'),
                (ds.t.values-273.15)*units('degC'),
                (prof.values-273.15)*units('degC'))

# Label the CAPE and CIN
skew.ax.text(-25, 400, f'CAPE',
             color='black', fontsize=15, verticalalignment='bottom', fontweight='bold')

skew.ax.text(-45, 280, f'CIN',
             color='black', fontsize=15, verticalalignment='bottom', fontweight='bold')

skew.ax.text(15, 900, f'CIN',
             color='black', fontsize=15, verticalalignment='bottom', fontweight='bold')

# Steps labeling 
plt.text(7, 480, '1', fontsize=12, color='white', ha='center', va='center',
         bbox=dict(facecolor='darkblue', edgecolor='none', boxstyle='circle', pad=0.4))
plt.text(-18, 640, '2', fontsize=12, color='white', ha='center', va='center',
         bbox=dict(facecolor='olive', edgecolor='none', boxstyle='circle', pad=0.4))
plt.text(20, 900, '3', fontsize=12, color='white', ha='center', va='center',
         bbox=dict(facecolor='brown', edgecolor='none', boxstyle='circle', pad=0.4))
plt.text(-17, 450, '4', fontsize=12, color='white', ha='center', va='center',
         bbox=dict(facecolor='black', edgecolor='none', boxstyle='circle', pad=0.4))
plt.show()
------------------


[31m---------------------------------------------------------------------------[39m
[31mKeyError[39m                                  Traceback (most recent call last)
[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/file_manager.py:219[39m, in [36mCachingFileManager._acquire_with_cache_info[39m[34m(self, needs_lock)[39m
[32m    218[39m [38;5;28;01mtry[39;00m:
[32m--> [39m[32m219[39m     file = [38;5;28;43mself[39;49m[43m.[49m[43m_cache[49m[43m[[49m[38;5;28;43mself[39;49m[43m.[49m[43m_key[49m[43m][49m
[32m    220[39m [38;5;28;01mexcept[39;00m [38;5;167;01mKeyError[39;00m:

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/lru_cache.py:56[39m, in [36mLRUCache.__getitem__[39m[34m(self, key)[39m
[32m     55[39m [38;5;28;01mwith[39;00m [38;5;28mself[39m._lock:
[32m---> [39m[32m56[39m     value = [38;5;28;43mself[39;49m[43m.[49m[43m_cache[49m[43m[[49m[43mkey[49m[43m][49m
[32m     57[39m     [38;5;28mself[39m._cache.move_to_end(key)

[31mKeyError[39m: [<class 'netCDF4._netCDF4.Dataset'>, ('/Users/martinjanssens/Documents/Wageningen/Teaching/MeteorologyClimate/metclim/metclim-jupyter-book/Exercises/valencia.nc',), 'r', (('clobber', True), ('diskless', False), ('format', 'NETCDF4'), ('persist', False)), '6b9fda75-d781-46a2-ad05-59b7b122255a']

During handling of the above exception, another exception occurred:

[31mFileNotFoundError[39m                         Traceback (most recent call last)
[36mCell[39m[36m [39m[32mIn[14][39m[32m, line 2[39m
[32m      1[39m [38;5;66;03m# With a sounding in it[39;00m
[32m----> [39m[32m2[39m ds = [43mxr[49m[43m.[49m[43mopen_dataset[49m[43m([49m[33;43m'[39;49m[33;43mExercises/valencia.nc[39;49m[33;43m'[39;49m[43m)[49m.isel(latitude=[32m0[39m,longitude=[32m0[39m).sel(valid_time=[33m'[39m[33m2024-10-29T15:00:00.000000000[39m[33m'[39m)
[32m      4[39m Rd = [32m287.05[39m
[32m      5[39m Rv = [32m461.5[39m [38;5;66;03m# J/kg/K, gas constant of water[39;00m

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/api.py:606[39m, in [36mopen_dataset[39m[34m(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, create_default_indexes, inline_array, chunked_array_type, from_array_kwargs, backend_kwargs, **kwargs)[39m
[32m    594[39m decoders = _resolve_decoders_kwargs(
[32m    595[39m     decode_cf,
[32m    596[39m     open_backend_dataset_parameters=backend.open_dataset_parameters,
[32m   (...)[39m[32m    602[39m     decode_coords=decode_coords,
[32m    603[39m )
[32m    605[39m overwrite_encoded_chunks = kwargs.pop([33m"[39m[33moverwrite_encoded_chunks[39m[33m"[39m, [38;5;28;01mNone[39;00m)
[32m--> [39m[32m606[39m backend_ds = [43mbackend[49m[43m.[49m[43mopen_dataset[49m[43m([49m
[32m    607[39m [43m    [49m[43mfilename_or_obj[49m[43m,[49m
[32m    608[39m [43m    [49m[43mdrop_variables[49m[43m=[49m[43mdrop_variables[49m[43m,[49m
[32m    609[39m [43m    [49m[43m*[49m[43m*[49m[43mdecoders[49m[43m,[49m
[32m    610[39m [43m    [49m[43m*[49m[43m*[49m[43mkwargs[49m[43m,[49m
[32m    611[39m [43m[49m[43m)[49m
[32m    612[39m ds = _dataset_from_backend_dataset(
[32m    613[39m     backend_ds,
[32m    614[39m     filename_or_obj,
[32m   (...)[39m[32m    625[39m     **kwargs,
[32m    626[39m )
[32m    627[39m [38;5;28;01mreturn[39;00m ds

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:758[39m, in [36mNetCDF4BackendEntrypoint.open_dataset[39m[34m(self, filename_or_obj, mask_and_scale, decode_times, concat_characters, decode_coords, drop_variables, use_cftime, decode_timedelta, group, mode, format, clobber, diskless, persist, auto_complex, lock, autoclose)[39m
[32m    736[39m [38;5;28;01mdef[39;00m[38;5;250m [39m[34mopen_dataset[39m(
[32m    737[39m     [38;5;28mself[39m,
[32m    738[39m     filename_or_obj: T_PathFileOrDataStore,
[32m   (...)[39m[32m    755[39m     autoclose=[38;5;28;01mFalse[39;00m,
[32m    756[39m ) -> Dataset:
[32m    757[39m     filename_or_obj = _normalize_path(filename_or_obj)
[32m--> [39m[32m758[39m     store = [43mNetCDF4DataStore[49m[43m.[49m[43mopen[49m[43m([49m
[32m    759[39m [43m        [49m[43mfilename_or_obj[49m[43m,[49m
[32m    760[39m [43m        [49m[43mmode[49m[43m=[49m[43mmode[49m[43m,[49m
[32m    761[39m [43m        [49m[38;5;28;43mformat[39;49m[43m=[49m[38;5;28;43mformat[39;49m[43m,[49m
[32m    762[39m [43m        [49m[43mgroup[49m[43m=[49m[43mgroup[49m[43m,[49m
[32m    763[39m [43m        [49m[43mclobber[49m[43m=[49m[43mclobber[49m[43m,[49m
[32m    764[39m [43m        [49m[43mdiskless[49m[43m=[49m[43mdiskless[49m[43m,[49m
[32m    765[39m [43m        [49m[43mpersist[49m[43m=[49m[43mpersist[49m[43m,[49m
[32m    766[39m [43m        [49m[43mauto_complex[49m[43m=[49m[43mauto_complex[49m[43m,[49m
[32m    767[39m [43m        [49m[43mlock[49m[43m=[49m[43mlock[49m[43m,[49m
[32m    768[39m [43m        [49m[43mautoclose[49m[43m=[49m[43mautoclose[49m[43m,[49m
[32m    769[39m [43m    [49m[43m)[49m
[32m    771[39m     store_entrypoint = StoreBackendEntrypoint()
[32m    772[39m     [38;5;28;01mwith[39;00m close_on_error(store):

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:525[39m, in [36mNetCDF4DataStore.open[39m[34m(cls, filename, mode, format, group, clobber, diskless, persist, auto_complex, lock, lock_maker, autoclose)[39m
[32m    521[39m [38;5;28;01melse[39;00m:
[32m    522[39m     manager = CachingFileManager(
[32m    523[39m         netCDF4.Dataset, filename, mode=mode, kwargs=kwargs
[32m    524[39m     )
[32m--> [39m[32m525[39m [38;5;28;01mreturn[39;00m [38;5;28;43mcls[39;49m[43m([49m[43mmanager[49m[43m,[49m[43m [49m[43mgroup[49m[43m=[49m[43mgroup[49m[43m,[49m[43m [49m[43mmode[49m[43m=[49m[43mmode[49m[43m,[49m[43m [49m[43mlock[49m[43m=[49m[43mlock[49m[43m,[49m[43m [49m[43mautoclose[49m[43m=[49m[43mautoclose[49m[43m)[49m

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:429[39m, in [36mNetCDF4DataStore.__init__[39m[34m(self, manager, group, mode, lock, autoclose)[39m
[32m    427[39m [38;5;28mself[39m._group = group
[32m    428[39m [38;5;28mself[39m._mode = mode
[32m--> [39m[32m429[39m [38;5;28mself[39m.format = [38;5;28;43mself[39;49m[43m.[49m[43mds[49m.data_model
[32m    430[39m [38;5;28mself[39m._filename = [38;5;28mself[39m.ds.filepath()
[32m    431[39m [38;5;28mself[39m.is_remote = is_remote_uri([38;5;28mself[39m._filename)

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:534[39m, in [36mNetCDF4DataStore.ds[39m[34m(self)[39m
[32m    532[39m [38;5;129m@property[39m
[32m    533[39m [38;5;28;01mdef[39;00m[38;5;250m [39m[34mds[39m([38;5;28mself[39m):
[32m--> [39m[32m534[39m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[43m.[49m[43m_acquire[49m[43m([49m[43m)[49m

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:528[39m, in [36mNetCDF4DataStore._acquire[39m[34m(self, needs_lock)[39m
[32m    527[39m [38;5;28;01mdef[39;00m[38;5;250m [39m[34m_acquire[39m([38;5;28mself[39m, needs_lock=[38;5;28;01mTrue[39;00m):
[32m--> [39m[32m528[39m [43m    [49m[38;5;28;43;01mwith[39;49;00m[43m [49m[38;5;28;43mself[39;49m[43m.[49m[43m_manager[49m[43m.[49m[43macquire_context[49m[43m([49m[43mneeds_lock[49m[43m)[49m[43m [49m[38;5;28;43;01mas[39;49;00m[43m [49m[43mroot[49m[43m:[49m
[32m    529[39m [43m        [49m[43mds[49m[43m [49m[43m=[49m[43m [49m[43m_nc4_require_group[49m[43m([49m[43mroot[49m[43m,[49m[43m [49m[38;5;28;43mself[39;49m[43m.[49m[43m_group[49m[43m,[49m[43m [49m[38;5;28;43mself[39;49m[43m.[49m[43m_mode[49m[43m)[49m
[32m    530[39m     [38;5;28;01mreturn[39;00m ds

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/contextlib.py:141[39m, in [36m_GeneratorContextManager.__enter__[39m[34m(self)[39m
[32m    139[39m [38;5;28;01mdel[39;00m [38;5;28mself[39m.args, [38;5;28mself[39m.kwds, [38;5;28mself[39m.func
[32m    140[39m [38;5;28;01mtry[39;00m:
[32m--> [39m[32m141[39m     [38;5;28;01mreturn[39;00m [38;5;28;43mnext[39;49m[43m([49m[38;5;28;43mself[39;49m[43m.[49m[43mgen[49m[43m)[49m
[32m    142[39m [38;5;28;01mexcept[39;00m [38;5;167;01mStopIteration[39;00m:
[32m    143[39m     [38;5;28;01mraise[39;00m [38;5;167;01mRuntimeError[39;00m([33m"[39m[33mgenerator didn[39m[33m'[39m[33mt yield[39m[33m"[39m) [38;5;28;01mfrom[39;00m[38;5;250m [39m[38;5;28;01mNone[39;00m

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/file_manager.py:207[39m, in [36mCachingFileManager.acquire_context[39m[34m(self, needs_lock)[39m
[32m    204[39m [38;5;129m@contextmanager[39m
[32m    205[39m [38;5;28;01mdef[39;00m[38;5;250m [39m[34macquire_context[39m([38;5;28mself[39m, needs_lock: [38;5;28mbool[39m = [38;5;28;01mTrue[39;00m) -> Iterator[T_File]:
[32m    206[39m [38;5;250m    [39m[33;03m"""Context manager for acquiring a file."""[39;00m
[32m--> [39m[32m207[39m     file, cached = [38;5;28;43mself[39;49m[43m.[49m[43m_acquire_with_cache_info[49m[43m([49m[43mneeds_lock[49m[43m)[49m
[32m    208[39m     [38;5;28;01mtry[39;00m:
[32m    209[39m         [38;5;28;01myield[39;00m file

[36mFile [39m[32m~/miniconda3/envs/metclim-book-env/lib/python3.13/site-packages/xarray/backends/file_manager.py:225[39m, in [36mCachingFileManager._acquire_with_cache_info[39m[34m(self, needs_lock)[39m
[32m    223[39m     kwargs = kwargs.copy()
[32m    224[39m     kwargs[[33m"[39m[33mmode[39m[33m"[39m] = [38;5;28mself[39m._mode
[32m--> [39m[32m225[39m file = [38;5;28;43mself[39;49m[43m.[49m[43m_opener[49m[43m([49m[43m*[49m[38;5;28;43mself[39;49m[43m.[49m[43m_args[49m[43m,[49m[43m [49m[43m*[49m[43m*[49m[43mkwargs[49m[43m)[49m
[32m    226[39m [38;5;28;01mif[39;00m [38;5;28mself[39m._mode == [33m"[39m[33mw[39m[33m"[39m:
[32m    227[39m     [38;5;66;03m# ensure file doesn't get overridden when opened again[39;00m
[32m    228[39m     [38;5;28mself[39m._mode = [33m"[39m[33ma[39m[33m"[39m

[36mFile [39m[32msrc/netCDF4/_netCDF4.pyx:2517[39m, in [36mnetCDF4._netCDF4.Dataset.__init__[39m[34m()[39m

[36mFile [39m[32msrc/netCDF4/_netCDF4.pyx:2154[39m, in [36mnetCDF4._netCDF4._ensure_nc_success[39m[34m()[39m

[31mFileNotFoundError[39m: [Errno 2] No such file or directory: '/Users/martinjanssens/Documents/Wageningen/Teaching/MeteorologyClimate/metclim/metclim-jupyter-book/Exercises/valencia.nc'

